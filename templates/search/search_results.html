{% extends "base.html" %}
{% load static %}
{% block content %}
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header border-0">
                    <div class="row justify-content-center mb-4">
                        <div class="col-lg-6">
                            <form method="get" action="{% url 'search' %}">
                                <div class="row g-2">
                                    <div class="col">
                                        <div class="position-relative mb-3">
                                            <input type="text"
                                                   name="searchQuery"
                                                   class="form-control form-control-lg bg-light border-light"
                                                   placeholder="Search here.."
                                                   value="{{ request.GET.searchQuery }}">
                                            <a class="btn btn-link link-success btn-lg position-absolute end-0 top-0"
                                               data-bs-toggle="offcanvas"
                                               data-bs-target="#offcanvasExample"
                                               aria-controls="offcanvasExample"><i class="ri-mic-fill"></i></a>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-primary btn-lg waves-effect waves-light">
                                            <i class="mdi mdi-magnify me-1"></i> Search
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <!--end col-->
                        {% if request.GET.searchQuery %}
                            <div class="col-lg-12">
                                <h5 class="fs-16 fw-semibold text-center mb-0">
                                    Showing results for "<span class="text-primary fw-medium fst-italic">{{ request.GET.searchQuery }}</span>"
                                </h5>
                            </div>
                        {% endif %}
                    </div>
                    <!--end row-->
                    <div class="offcanvas offcanvas-top"
                         tabindex="-1"
                         id="offcanvasExample"
                         aria-labelledby="offcanvasExampleLabel">
                        <div class="offcanvas-body">
                            <button type="button"
                                    class="btn-close text-reset float-end"
                                    data-bs-dismiss="offcanvas"
                                    aria-label="Close"></button>
                            <div class="d-flex flex-column h-100 justify-content-center align-items-center">
                                <div class="search-voice">
                                    <i class="ri-mic-fill align-middle"></i>
                                    <span class="voice-wave"></span>
                                    <span class="voice-wave"></span>
                                    <span class="voice-wave"></span>
                                </div>
                                <h4>Talk to me, what can I do for you?</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <ul class="nav nav-tabs nav-tabs-custom" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active"
                               data-bs-toggle="tab"
                               href="#all"
                               role="tab"
                               aria-selected="true">
                                <i class="ri-search-2-line text-muted align-bottom me-1"></i> Điểm Đến
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"
                               data-bs-toggle="tab"
                               href="#images"
                               role="tab"
                               aria-selected="false">
                                <i class="ri-image-fill text-muted align-bottom me-1"></i> Images
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"
                               data-bs-toggle="tab"
                               href="#news"
                               role="tab"
                               aria-selected="false">
                                <i class="ri-list-unordered text-muted align-bottom me-1"></i> News
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link"
                               data-bs-toggle="tab"
                               href="#video"
                               role="tab"
                               aria-selected="false">
                                <i class="ri-video-line text-muted align-bottom me-1"></i> Videos
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-4">
                    <div class="tab-content text-muted">
                        <div class="tab-pane active" id="all" role="tabpanel">
                            <div class="row">
                                {% for location in location_page_obj %}
                                    <div class="col-lg-6">
                                        <div class="card border">
                                            <div class="card-body">
                                                <div class="d-sm-flex">
                                                    <div class="flex-shrink-0">
                                                        <img src="{{ location.first_image }}"
                                                             alt=""
                                                             width="115"
                                                             height="100"
                                                             class="rounded-1" />
                                                    </div>
                                                    <div class="flex-grow-1 ms-sm-4 mt-3 mt-sm-0 flex-grow-container">
                                                        <ul class="list-inline mb-2">
                                                            <li class="list-inline-item">
                                                                <span class="badge badge-soft-success fs-11">{{ location.tags.all|join:', ' }}</span>
                                                            </li>
                                                        </ul>
                                                        <h5>
                                                            <a href="{% url 'detail_location' location.id %}">{{ location.name }}</a>
                                                        </h5>
                                                        <ul class="list-inline mb-0">
                                                            <li class="list-inline-item single-line-address">
                                                                <i class="ri-user-3-fill text-success align-middle me-1"></i> {{ location.address }}
                                                            </li>
                                                            <li class="list-inline-item">
                                                                <i class="ri-calendar-2-fill text-success align-middle me-1"></i> {{ location.created_at|date:'F d, Y' }}
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--end card-->
                                    </div>
                                    <!--end col-->
                                {% endfor %}
                            </div>
                            <div>
                                <ul class="pagination pagination-separated justify-content-center mb-0">
                                    <!-- Previous page link -->
                                    {% if location_page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?location_page=1&searchQuery={{ search_query }}">
                                                <i class="mdi mdi-chevron-left"></i>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="mdi mdi-chevron-left"></i></span>
                                        </li>
                                    {% endif %}
                                    <!-- Page numbers -->
                                    {% for num in location_page_obj.paginator.page_range %}
                                        {% if num == location_page_obj.number %}
                                            <li class="page-item active" aria-current="page">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > location_page_obj.number|add:'-3' and num < location_page_obj.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                   href="?location_page={{ num }}&searchQuery={{ search_query }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    <!-- Next page link -->
                                    {% if location_page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?location_page={{ location_page_obj.paginator.num_pages }}&searchQuery={{ search_query }}">
                                                <i class="mdi mdi-chevron-right"></i>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="mdi mdi-chevron-right"></i></span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                        <div class="tab-pane" id="images" role="tabpanel">
                            <div class="gallery-light">
                                <div class="row">
                                    {% for image in image_page_obj %}
                                        <div class="col-xl-3 col-lg-4 col-sm-6">
                                            <div class="gallery-box card">
                                                <div class="gallery-container">
                                                    <a class="image-popup" href="{{ image.image.url }}" title="">
                                                        <li class="crop">
                                                            <img class="gallery-img img-fluid mx-auto"
                                                                 src="{{ image.image.url }}"
                                                                 alt=""
                                                                 width="auto"
                                                                 height="auto" />
                                                        </li>
                                                        <div class="gallery-overlay">
                                                            <h5 class="overlay-caption">{{ image.title }}</h5>
                                                        </div>
                                                    </a>
                                                </div>
                                                <div class="box-content">
                                                    <div class="d-flex align-items-center mt-2">
                                                        <div class="flex-grow-1 text-muted">
                                                            by <a href="" class="text-body text-truncate">HQ</a>
                                                        </div>
                                                        <div class="flex-shrink-0">
                                                            <div class="d-flex gap-3">
                                                                <a class="text-body text-truncate">{{ image.created_at }}</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--end col-->
                                    {% endfor %}
                                </div>
                                <!--end row-->
                                <div>
                                    <ul class="pagination pagination-separated justify-content-center mb-0">
                                        <!-- Previous page link -->
                                        {% if image_page_obj.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                   href="?image_page={{ image_page_obj.previous_page_number }}&searchQuery={{ request.GET.searchQuery }}#images">
                                                    <i class="mdi mdi-chevron-left"></i>
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link"><i class="mdi mdi-chevron-left"></i></span>
                                            </li>
                                        {% endif %}
                                        <!-- Page numbers -->
                                        {% for num in image_page_obj.paginator.page_range %}
                                            {% if num == image_page_obj.number %}
                                                <li class="page-item active" aria-current="page">
                                                    <span class="page-link">{{ num }}</span>
                                                </li>
                                            {% elif num > image_page_obj.number|add:'-3' and num < image_page_obj.number|add:'3' %}
                                                <li class="page-item">
                                                    <a class="page-link"
                                                       href="?image_page={{ num }}&searchQuery={{ request.GET.searchQuery }}#images">{{ num }}</a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                        <!-- Next page link -->
                                        {% if image_page_obj.has_next %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                   href="?image_page={{ image_page_obj.next_page_number }}&searchQuery={{ request.GET.searchQuery }}#images">
                                                    <i class="mdi mdi-chevron-right"></i>
                                                </a>
                                            </li>
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link"><i class="mdi mdi-chevron-right"></i></span>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--end tab-content-->
                </div>
                <!--end card-body-->
            </div>
            <!--end card -->
        </div>
        <!--end card -->
    </div>
    <style>
    .single-line-address {
        white-space: nowrap;
        overflow: hidden; 
        text-overflow: ellipsis; 
        display: inline-block;
        max-width: 100%; 
    }
    .crop {
        height: 200px;
        width: 400px;
        overflow: hidden;
        display: block
       }
    .crop img {
        height: auto;
        width: 400px;
       }
    .flex-grow-container {
        overflow: hidden;
        }
      
    </style>
    <!-- glightbox js -->
    <script src="{% static "assets/libs/glightbox/js/glightbox.min.js" %}"></script>
    <!-- swiper js -->
    <script src="{% static "assets/libs/swiper/swiper-bundle.min.js" %}"></script>
    <!-- search-result init js -->
    <script src="{% static "assets/js/pages/search-result.init.js" %}"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Function to activate the correct tab based on URL hash
        function activateTabFromHash() {
            var hash = window.location.hash;
            var tabTrigger = document.querySelector('.nav-tabs-custom .nav-link[href="' + hash + '"]');
            
            if (tabTrigger) {
                // Deactivate all tabs
                var tabLinks = document.querySelectorAll('.nav-tabs-custom .nav-link');
                tabLinks.forEach(function(link) {
                    link.classList.remove('active');
                });
                
                // Activate the corresponding tab
                tabTrigger.classList.add('active');
                
                // Deactivate all tab panes
                var tabPanes = document.querySelectorAll('.tab-content .tab-pane');
                tabPanes.forEach(function(pane) {
                    pane.classList.remove('show', 'active');
                });
                
                // Activate the corresponding tab pane
                var tabPane = document.querySelector(hash);
                tabPane.classList.add('show', 'active');
            }
        }
    
        // Activate tab on page load based on URL hash
        activateTabFromHash();
    
        // Handle click events on tab links to update URL hash
        var tabLinks = document.querySelectorAll('.nav-tabs-custom .nav-link');
        
        tabLinks.forEach(function(link) {
            link.addEventListener('click', function(event) {
                var href = this.getAttribute('href');
                var hash = href.substring(href.indexOf('#'));
                
                // Update URL hash without triggering scroll
                history.replaceState(null, null, hash);
                
                // Activate the clicked tab
                activateTabFromHash();
            });
        });
    });
    </script>
{% endblock content %}
