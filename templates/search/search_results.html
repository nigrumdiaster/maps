{% extends "base.html" %}
{% load static %}
{% block content %}
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header border-0">
                    <div class="row justify-content-center mb-4">
                        <div class="col-lg-6">
                            <form method="get" action="{% url 'search' %}">
                                <div class="row g-2">
                                    <div class="col">
                                        <div class="position-relative mb-3">
                                            <input type="text"
                                                   name="searchQuery"
                                                   class="form-control form-control-lg bg-light border-light"
                                                   placeholder="Search here.."
                                                   value="{{ request.GET.searchQuery }}">
                                            <a class="btn btn-link link-success btn-lg position-absolute end-0 top-0"
                                               data-bs-toggle="offcanvas"
                                               data-bs-target="#offcanvasExample"
                                               aria-controls="offcanvasExample"><i class="ri-mic-fill"></i></a>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-primary btn-lg waves-effect waves-light">
                                            <i class="mdi mdi-magnify me-1"></i> Search
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <!--end col-->
                        {% if request.GET.searchQuery %}
                            <div class="col-lg-12">
                                <h5 class="fs-16 fw-semibold text-center mb-0">
                                    Showing results for "<span class="text-primary fw-medium fst-italic">{{ request.GET.searchQuery }}</span>"
                                </h5>
                            </div>
                        {% endif %}
                    </div>
                    <!--end row-->
                    <div class="offcanvas offcanvas-top"
                         tabindex="-1"
                         id="offcanvasExample"
                         aria-labelledby="offcanvasExampleLabel">
                        <div class="offcanvas-body">
                            <button type="button"
                                    class="btn-close text-reset float-end"
                                    data-bs-dismiss="offcanvas"
                                    aria-label="Close"></button>
                            <div class="d-flex flex-column h-100 justify-content-center align-items-center">
                                <div class="search-voice">
                                    <i class="ri-mic-fill align-middle"></i>
                                    <span class="voice-wave"></span>
                                    <span class="voice-wave"></span>
                                    <span class="voice-wave"></span>
                                </div>
                                <h4>Talk to me, what can I do for you?</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <ul class="nav nav-tabs nav-tabs-custom" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#all" role="tab" aria-selected="true">
                            <i class="ri-search-2-line text-muted align-bottom me-1"></i> Điểm Đến
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#images" role="tab" aria-selected="false">
                            <i class="ri-image-fill text-muted align-bottom me-1"></i> Images
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#posts" role="tab" aria-selected="false">
                            <i class="ri-list-unordered text-muted align-bottom me-1"></i> Posts
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#video" role="tab" aria-selected="false">
                            <i class="ri-video-line text-muted align-bottom me-1"></i> Videos
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body p-4">
                <div class="tab-content text-muted">
                    <div class="tab-pane active" id="all" role="tabpanel">
                        <div class="row">
                            {% for location in location_page_obj %}
                                <div class="col-lg-6">
                                    <div class="card border">
                                        <div class="card-body">
                                            <div class="d-sm-flex">
                                                <div class="flex-shrink-0">
                                                    <img src="{{location.first_image}}" alt="" width="115" height="100" class="rounded-1" />
                                                </div>
                                                <div class="flex-grow-1 ms-sm-4 mt-3 mt-sm-0" style="overflow: hidden">
                                                    <ul class="list-inline mb-2">
                                                        <li class="list-inline-item"><span class="badge badge-soft-success fs-11">{{ location.tags.all|join:', ' }}</span></li>
                                                    </ul>
                                                    <h5><a href="{% url 'detail_location' location.id %}">{{location.name}}</a></h5>
                                                    <ul class="list-inline mb-0">
                                                        <li class="list-inline-item single-line-address"><i class="ri-user-3-fill text-success align-middle me-1"></i> {{location.address}}</li>
                                                        <li class="list-inline-item"><i class="ri-calendar-2-fill text-success align-middle me-1"></i> {{ location.created_at|date:'F d, Y' }}</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--end card-->
                                </div>
                            <!--end col-->
                            {%endfor%}
                        </div>     
                        <div>
                            <ul class="pagination pagination-separated justify-content-center mb-0">
                                <!-- Previous page link -->
                                {% if location_page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?location_page=1&searchQuery={{ search_query }}">
                                        <i class="mdi mdi-chevron-left"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="mdi mdi-chevron-left"></i></span>
                                </li>
                                {% endif %}
                        
                                <!-- Page numbers -->
                                {% for num in location_page_obj.paginator.page_range %}
                                    {% if num == location_page_obj.number %}
                                    <li class="page-item active" aria-current="page">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                    {% elif num > location_page_obj.number|add:'-3' and num < location_page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?location_page={{ num }}&searchQuery={{ search_query }}">{{ num }}</a>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                        
                                <!-- Next page link -->
                                {% if location_page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?location_page={{ location_page_obj.paginator.num_pages }}&searchQuery={{ search_query }}">
                                        <i class="mdi mdi-chevron-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="mdi mdi-chevron-right"></i></span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>                      
                    </div>
                    <div class="tab-pane" id="images" role="tabpanel">
                        <div class="row gallery-wrapper"> 
                            <div class="row">
                                {% for image in image_page_obj %}
                                    <div class="element-item col-xl-3 col-lg-4 col-sm-6 project designing development" data-category="designing development">                                        
                                        <div class="gallery-box card">
                                            <div class="gallery-container">
                                                <a class="lightGallery" href="{{image.image.url}}" title="">
                                                    <li class="crop">
                                                        <img class="gallery-img img-fluid mx-auto" src="{{image.image.url}}" alt=""/>
                                                    </li>
                                                    
                                                    <div class="gallery-overlay">
                                                        <h5 class="overlay-caption">{{image.title}}</h5>
                                                    </div>
                                                </a>
                                            </div>
                                            <div class="box-content">
                                                <div class="d-flex align-items-center mt-2">
                                                    <div class="flex-grow-1 text-muted">by <a href="" class="text-body text-truncate">HQ</a></div>
                                                    <div class="flex-shrink-0">
                                                        <img src="{{ location.first_image }}"
                                                             alt=""
                                                             width="115"
                                                             height="100"
                                                             class="rounded-1" />
                                                    </div>
                                                    <div class="flex-grow-1 ms-sm-4 mt-3 mt-sm-0 flex-grow-container">
                                                        <ul class="list-inline mb-2">
                                                            <li class="list-inline-item">
                                                                <span class="badge badge-soft-success fs-11">{{ location.tags.all|join:', ' }}</span>
                                                            </li>
                                                        </ul>
                                                        <h5>
                                                            <a href="{% url 'detail_location' location.id %}">{{ location.name }}</a>
                                                        </h5>
                                                        <ul class="list-inline mb-0">
                                                            <li class="list-inline-item single-line-address">
                                                                <i class="ri-user-3-fill text-success align-middle me-1"></i> {{ location.address }}
                                                            </li>
                                                            <li class="list-inline-item">
                                                                <i class="ri-calendar-2-fill text-success align-middle me-1"></i> {{ location.created_at|date:'F d, Y' }}
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!--end card-->
                                    </div>
                                    <!--end col-->
                                {% endfor %}
                            </div>
                            <div>
                                <ul class="pagination pagination-separated justify-content-center mb-0">
                                    <!-- Previous page link -->
                                    {% if location_page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?location_page=1&searchQuery={{ search_query }}">
                                                <i class="mdi mdi-chevron-left"></i>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="mdi mdi-chevron-left"></i></span>
                                        </li>
                                    {% endif %}
                                    <!-- Page numbers -->
                                    {% for num in location_page_obj.paginator.page_range %}
                                        {% if num == location_page_obj.number %}
                                            <li class="page-item active" aria-current="page">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > location_page_obj.number|add:'-3' and num < location_page_obj.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link"
                                                   href="?location_page={{ num }}&searchQuery={{ search_query }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    <!-- Next page link -->
                                    {% if location_page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="?location_page={{ location_page_obj.paginator.num_pages }}&searchQuery={{ search_query }}">
                                                <i class="mdi mdi-chevron-right"></i>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link"><i class="mdi mdi-chevron-right"></i></span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>   
                        </div>
                    </div>
                    <div class="tab-pane" id="posts" role="tabpanel">
                        <div class="row">
                            {% for post in post_page_obj %}
                            <div class="col-xxl-6 mb-4">
                                <div class="card">
                                    <div class="row g-0">
                                        <div class="col-md-4">
                                            <a href="{% url 'detail_post' post.id %}">
                                                {% if post.image %}
                                                <img class="rounded-start img-fluid h-100 object-cover" src="{{ post.image.url }}" alt="{{ post.title }}">
                                                {% else %}
                                                <img class="rounded-start img-fluid h-100 object-cover" src="{% static 'images/default.jpg' %}" alt="No Image">
                                                {% endif %}
                                            </a>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="card-body">
                                                <h5 class="card-title mb-2" style="overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; max-height: 3em; line-height: 1.5em; min-height: 3em;">
                                                    <a href="{% url 'detail_post' post.id %}">{{ post.title }}</a>
                                                </h5>
                                                <p class="card-text text-muted mb-0" style="overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; max-height: 3em; line-height: 1.5em; min-height: 3em;">{{ post.notes }}</p>
                                            </div>
                                            <div class="card-footer">
                                                <p class="card-text"><small class="text-muted">Last updated {{ post.created_at|timesince }} ago</small></p>
                                                <p class="card-text"><small class="text-muted">Views: {{ post.views }}</small></p>
                                                <p class="card-text"><small class="text-muted">Post Type: {{ post.post_type }}</small></p>
                                            </div>
                                        </div>
                                    </div>
                                </div><!-- end card -->
                            </div>
                            {% endfor %}
                        </div>
                        <div>
                            <ul class="pagination pagination-separated justify-content-center mb-0">
                                <!-- Previous page link -->
                                {% if post_page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?post_page={{ post_page_obj.previous_page_number }}&searchQuery={{ request.GET.searchQuery }}#posts">
                                        <i class="mdi mdi-chevron-left"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="mdi mdi-chevron-left"></i></span>
                                </li>
                                {% endif %}
                            
                                <!-- Page numbers -->
                                {% for num in post_page_obj.paginator.page_range %}
                                    {% if num == post_page_obj.number %}
                                    <li class="page-item active" aria-current="page">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                    {% elif num > post_page_obj.number|add:'-3' and num < post_page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?post_page={{ num }}&searchQuery={{ request.GET.searchQuery }}#posts">{{ num }}</a>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            
                                <!-- Next page link -->
                                {% if post_page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?post_page={{ post_page_obj.next_page_number }}&searchQuery={{ request.GET.searchQuery }}#posts">
                                        <i class="mdi mdi-chevron-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="mdi mdi-chevron-right"></i></span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    <div class="tab-pane" id="video" role="tabpanel">
                        <div class="row">
                            {% for video in video_page_obj %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ video.title }}</h5>
                                        {% if video.upload %}
                                        <video width="100%" controls>
                                            <source src="{{ video.upload.url }}" type="video/mp4" />
                                            Your browser does not support the video tag.
                                        </video>
                                        {% elif video.youtube_url %}
                                        <div class="ratio ratio-16x9">
                                            <iframe
                                                width="100%"
                                                height="auto"
                                                src="https://www.youtube.com/embed/{{ video.youtube_url|slice:'-11:' }}"
                                                frameborder="0"
                                                allowfullscreen>
                                            </iframe>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div>
                            <ul class="pagination pagination-separated justify-content-center mb-0">
                                <!-- Previous page link -->
                                {% if video_page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?video_page={{ video_page_obj.previous_page_number }}&searchQuery={{ request.GET.searchQuery }}#video">
                                        <i class="mdi mdi-chevron-left"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="mdi mdi-chevron-left"></i></span>
                                </li>
                                {% endif %}
                            
                                <!-- Page numbers -->
                                {% for num in video_page_obj.paginator.page_range %}
                                    {% if num == video_page_obj.number %}
                                    <li class="page-item active" aria-current="page">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                    {% elif num > video_page_obj.number|add:'-3' and num < video_page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?video_page={{ num }}&searchQuery={{ request.GET.searchQuery }}#video">{{ num }}</a>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                            
                                <!-- Next page link -->
                                {% if video_page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?video_page={{ video_page_obj.next_page_number }}&searchQuery={{ request.GET.searchQuery }}#video">
                                        <i class="mdi mdi-chevron-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="mdi mdi-chevron-right"></i></span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    <!--end tab-content-->
                </div>
            </div>
        </div>
    </div> <!-- end col -->
</div>

<style>
    .single-line-address {
        white-space: nowrap;
        overflow: hidden; 
        text-overflow: ellipsis; 
        display: inline-block;
        max-width: 100%; 
    }
    .crop {
        height: 200px;
        width: 400px;
        overflow: hidden;
        display: block
       }
    .crop img {
        height: auto;
        width: 400px;
       }
    .flex-grow-container {
        overflow: hidden;
        }
      
    </style>
    <!-- glightbox js -->
    <script src="{% static "assets/libs/glightbox/js/glightbox.min.js" %}"></script>
    <!-- swiper js -->
    <script src="{% static "assets/libs/swiper/swiper-bundle.min.js" %}"></script>
    <!-- search-result init js -->
    <script src="{% static "assets/js/pages/search-result.init.js" %}"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Function to activate the correct tab based on URL hash
        function activateTabFromHash() {
            var hash = window.location.hash;
            var tabTrigger = document.querySelector('.nav-tabs-custom .nav-link[href="' + hash + '"]');
            
            if (tabTrigger) {
                // Deactivate all tabs
                var tabLinks = document.querySelectorAll('.nav-tabs-custom .nav-link');
                tabLinks.forEach(function(link) {
                    link.classList.remove('active');
                });
                
                // Activate the corresponding tab
                tabTrigger.classList.add('active');
                
                // Deactivate all tab panes
                var tabPanes = document.querySelectorAll('.tab-content .tab-pane');
                tabPanes.forEach(function(pane) {
                    pane.classList.remove('show', 'active');
                });
                
                // Activate the corresponding tab pane
                var tabPane = document.querySelector(hash);
                tabPane.classList.add('show', 'active');
            }
        }
    
        // Activate tab on page load based on URL hash
        activateTabFromHash();
    
        // Handle click events on tab links to update URL hash
        var tabLinks = document.querySelectorAll('.nav-tabs-custom .nav-link');
        
        tabLinks.forEach(function(link) {
            link.addEventListener('click', function(event) {
                var href = this.getAttribute('href');
                var hash = href.substring(href.indexOf('#'));
                
                // Update URL hash without triggering scroll
                history.replaceState(null, null, hash);
                
                // Activate the clicked tab
                activateTabFromHash();
            });
        });
    });

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/lightgallery.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/thumbnail/lg-thumbnail.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/zoom/lg-zoom.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/fullscreen/lg-fullscreen.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/autoplay/lg-autoplay.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/share/lg-share.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/hash/lg-hash.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/pager/lg-pager.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.2/plugins/rotate/lg-rotate.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const galleryWrapper = document.querySelector('.gallery-wrapper');
  if (galleryWrapper) {
    lightGallery(galleryWrapper, {
      selector: '.lightGallery',
      plugins: [lgThumbnail, lgZoom, lgFullscreen, lgAutoplay, lgShare, lgHash, lgPager, lgRotate],
      thumbnail: true,
      zoom: true,
      fullScreen: true,
      autoplay: true,
      share: true,
      hash: true,
      pager: true,
      toolbarButtons: ['close', 'zoomIn', 'zoomOut', 'download', 'share', 'rotateLeft', 'rotateRight', 'flipHorizontal', 'flipVertical', 'actualSize'],
    });
  }
});
    </script>
{% endblock content %}

